---
layout: post
title: Event-Driven Infrastructure with App Configuration
subtitle: Triggering Azure API Management Deployments
tags: [Azure, Azure App Configuration, Azure Event Grid, Azure Automation Runbooks]
comments: true
published: false
share-img: https://cdn.svenmalvik.com/images/appc-apim-autmation-eventgrid-logos.png
image: https://cdn.svenmalvik.com/images/appc-apim-autmation-eventgrid-logos.png
featured-image: https://cdn.svenmalvik.com/images/appc-apim-autmation-eventgrid-logos.png
---

*Azure App Configuration is great for externalizing application configurations. What we also can use it for is for updating infrastructure. At [Vipps](https://vipps.no) we have two AKS clusters. Only one cluster is active at any given time. We use the second cluster to test AKS upgrades. In front of AKS is Azure API Management that routes the traffic either to AKS-blue or AKS-green. The information of what cluster is active and what is inactive is stored in Azure App Configuration. In this post, I will show you how we automated a switch from one AKS cluster to the other cluster with Azure Event Grid.*

![Event flow diagram of how Azure App Configuration events trigger Azure API Management deployments](https://cdn.svenmalvik.com/images/apim-aks-blue-green.png)*Event flow diagram of how Azure App Configuration events trigger Azure API Management deployments*

## Agenda

* [Overview](#overview)
* [Deploy App Configuration](#deploy-azure-app-configuration)
* [Deploy API Management](#deploy-azure-api-management)
* [Create Azure Automation Account](#create-azure-automation-account)
* [Create Runbook](#create-runbook)
* [Importing Az modules into Azure Automation Account](#importing-az-modules-into-azure-automation-account)
* [Reading key/value pairs from App Configuration](#reading-key-value-pairs-from-azure-app-configuration)
* [Deploy named value to Azure API Management](#deploy-named-value-to-azure-api-management)
* [Create Event subscription from Azure App Configuration](#create-event-subscription-from-azure-app-configuration)
* [Resources](#resources)

## <a name="overview"></a>Overview

Before we start, I will give a high-level overview of the event flow between the services we use. The data of what cluster is active is stored in Azure App Configuration. Whenever we change this value, meaning we set the other AKS cluster as active, a change event is send to Azure Event Grid. Azure Automation subscribes to Event Grid and triggers an update in Azure API Management that routes the traffic to either AKS-blue or AKS-green. You find more information about [Policies in Azure API Management](https://www.svenmalvik.com/azure-apim-policies/) in a previous post.

![Event flow diagram of how Azure App Configuration events trigger Azure API Management deployments](https://cdn.svenmalvik.com/images/appc-apim-autmation-eventgrid.png)*Event flow diagram of how Azure App Configuration events trigger Azure API Management deployments*

## <a name="deploy-azure-app-configuration"></a>Deploy Azure App Configuration

We will deploy an instance of Azure App Configuration Service from Azure Cloud Shell with Azure CLI. To do so we select `Bash` as shown below.

![Azure Cloud Shell for Bash](https://cdn.svenmalvik.com/images/azure-appconfiguration-0.png)*Azure Cloud Shell for Bash*

Before we start, we have to make sure that we are in the correct subscription.

```bash
# Make sure you are in the correct subscription
az account show

# Eventually switch the current subscription
az account set --subscription "YOUR-SUBSCRIPTION"
```

We can now deploy a new instance of Azure App Configuration Service.

> [Complete list of all Azure CLI commands for Azure App Configuration](https://docs.microsoft.com/en-us/cli/azure/appconfig?view=azure-cli-latest)

```bash
# We'll put our resources into a new resource group.
az group create --name "appc2apim-rg" --location "westeurope"

# You can have one Free instance per subscription
az appconfig create --name "appc2apim-appc" --location "westeurope" --resource-group "appc2apim-rg" --sku free
```

## <a name="deploy-azure-api-management"></a>Deploy Azure API Management

To deploy an instance of Azure API Management we use PowerShell from within Cloud Shell. You can easily switch from Bash to PowerShell:

![Azure Cloud Shell Bash and PowerShell](https://cdn.svenmalvik.com/images/cloud-shell.png)*Azure Cloud Shell Bash and PowerShell*

Now run the following command to create an instance of Azure API Management. This will take about 2 minutes.

```powershell
New-AzApiManagement -ResourceGroupName "appc2apim-rg" -Name "appc2apim-apim-service" -Location "westeurope" -Organization "<ORGANIZATION>" -AdminEmail "<YOUR_EMAIL" --Sku "Consumption"
```

## <a name="create-azure-automation-account"></a>Create Azure Automation Account

Now that we have Azure App Configuration and Azure API Management in place, we need to tie them together. First, we create an Azure Automation Account.

![Create Azure Automation Account](https://cdn.svenmalvik.com/images/azure-automation-1.png)*Create Azure Automation Account*

We give it a name, subscription, a resource group. We also create a service principle.

![Configure Azure Automation Account](https://cdn.svenmalvik.com/images/azure-automation-2.png)*Configure Azure Automation Account*

We can see that a service principle was created.

![Azure Automation Account Service Principle](https://cdn.svenmalvik.com/images/azure-automation-3.png)*Azure Automation Account Service Principle*

## <a name="create-runbook"></a>Create Runbook

When we first created our Automation Account, we will notice that we got three runbooks that we could use to get started. You can chose to delete those like I did.

![Default Runbooks](https://cdn.svenmalvik.com/images/azure-automation-4.png)*Default Runbooks*

Then I created a runbook with type PowerShell. This will be empty and we will write the code for it later.

![Create Runbook](https://cdn.svenmalvik.com/images/azure-automation-6.png)*Create Runbook*

## <a name="importing-az-modules-into-azure-automation-account"></a>Importing Az modules into Azure Automation Account

![Az.ApiManagement PowerShell Module](https://cdn.svenmalvik.com/images/azure-automation-8.png)*Az.ApiManagement PowerShell Module*
![Importing Az.ApiManagement PowerShell Module](https://cdn.svenmalvik.com/images/azure-automation-8.png)*Importing Az.ApiManagement PowerShell Module*
![Az.AppConfiguration PowerShell Module](https://cdn.svenmalvik.com/images/azure-automation-11.png)*Az.AppConfiguration PowerShell Module*

At this time the Az.AppConfiguration PowerShell Module does not provide a `Get-`-function for reading configurations from Azure App Configuration. This is of course a problem and requires from us to use the REST interface of App Configuration.

![Az.AppConfiguration Functions Available](https://cdn.svenmalvik.com/images/azure-automation-12.png)*Az.AppConfiguration Functions Available*

## <a name="reading-key-value-pairs-from-azure-app-configuration"></a>Reading key/value pairs from Azure App Configuration
PowerShell module can't read from App Configuration at the time of this writing

## <a name="deploy-named-value-to-azure-api-management"></a>Deploy named value to Azure API Management

## <a name="create-event-subscription-from-azure-app-configuration"></a>Create Event subscription from Azure App Configuration

## <a name="resources"></a>Resources

- [Introduction to Azure App Configuration](https://www.svenmalvik.com/azure-appconfiguration/)
- [Events in Azure App Configuration](https://docs.microsoft.com/en-us/azure/azure-app-configuration/concept-app-configuration-event)
- [Introduction to Azure Event Grid](https://docs.microsoft.com/en-us/azure/event-grid/overview)
- [Update Azure API Management Named Value from Runbook](https://gist.github.com/svenmalvik/a3fec9487aa82948d46f45f87ae805dc)
